(function(){"use strict";const g={distance(e,t){return Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2)},midpoint(e,t){return{x:e.x+(t.x-e.x)/2,y:e.y+(t.y-e.y)/2}},magnitude(e,t={x:0,y:0}){return this.distance(t,e)},angle(e,t={x:0,y:0}){return Math.atan2(e.y-t.y,e.x-t.x)},translate(e,t){return{x:e.x+t.x,y:e.y+t.y}},polar(e,t={x:0,y:0}){return{ang:this.angle(e,t),mag:this.magnitude(e,t)}},cartesian({ang:e,mag:t},n={x:0,y:0}){return{x:Math.cos(e)*t+n.x,y:Math.sin(e)*t+n.y}},normalize(e,t=1){const n=this.magnitude(e);return{x:e.x/n*t,y:e.y/n*t}},dot(e,t){return e.x*t.x+e.y*t.y},angleFromSides(e,t,n){const a=e*e+t*t-n*n,r=2*e*t;return r!==0?Math.acos(a/r):0},nearestPointOnLine(e,t,n){const a=((n.x-e.x)*(t.x-e.x)+(n.y-e.y)*(t.y-e.y))/Math.pow(this.distance(e,t),2);let r=e.x+a*(t.x-e.x),i=e.y+a*(t.y-e.y);return{x:this.between(r,e.x,t.x),y:this.between(i,e.y,t.y)}},intersect(e,t,n,a){let r=(a.x-n.x)*(e.y-t.y)-(e.x-t.x)*(a.y-n.y);if(r==0)return null;let i=((n.y-a.y)*(e.x-n.x)+(a.x-n.x)*(e.y-n.y))/r,s=((e.y-t.y)*(e.x-n.x)+(t.x-e.x)*(e.y-n.y))/r;return i<0||i>1||s<0||s>1?null:{x:e.x+i*(t.x-e.x),y:e.y+i*(t.y-e.y)}},randInt(e,t){return e=Math.ceil(e),t=Math.floor(t),e>=t?e:Math.floor(Math.random()*(t-e)+.99999)+e},chance(e,t=1){return Math.random()<e/t},choice(e){return e[this.randInt(0,e.length-1)]},clamp(e,t,n){return e<t?t:e>n?n:e},between(e,t,n){return this.clamp(e,Math.min(t,n),Math.max(t,n))},wrap(e,t,n){for(;e<t;)e+=n-t;for(;e>n;)e-=n-t;return e},round(e,t=0){const n=Math.pow(10,t);return Math.round(e*n)/n},sign(e){return e<0?-1:1},average(e){return e.length?e.reduce((t,n)=>t+n,0)/e.length:0},rollingAverage(e,t,n){return(e*(n-1)+t)/n}},b={clear({ctx:e}){e.clearRect(0,0,e.canvas.width,e.canvas.height)},resize({ctx:e,w:t,h:n,ratio:a}){a=a||window.devicePixelRatio||1;const r=e.canvas.getBoundingClientRect(),i=t||r.width||e.canvas.width,s=n||r.height||e.canvas.height;e.canvas.width=i*a,e.canvas.height=s*a,e.scale(a,a),e.canvas.style.width=`${i}px`,e.canvas.style.height=`${s}px`},fade({ctx:e}){const t=e.canvas.width,n=e.canvas.height,a=e.getImageData(0,0,t,n),r=a.data;for(let i=0;i<t*n*4;i+=4)r[i]>0&&(r[i]-=1),r[i+1]>0&&(r[i+1]-=1),r[i+2]>0&&(r[i+2]-=1);e.putImageData(a,0,0)},text({ctx:e,pos:t,msg:n,font:a="monospace",size:r=16,color:i,colorOutline:s}){e.save(),e.font=`${r}px ${a}`,i&&(e.fillStyle=i),e.fillText(n,t.x,t.y+r),s&&(e.fillStyle=s,e.strokeText(n,t.x,t.y+r)),e.restore()},image({ctx:e,img:t,pos:n,pos2:a,alpha:r}){e.save(),r&&(e.globalAlpha=r),a?e.drawImage(t,n.x,n.y,a.x-n.x,a.y-n.y):e.drawImage(t,n.x,n.y),e.restore()},pixel({ctx:e,pos:t,color:n}){e.save(),n&&(e.fillStyle=n),e.fillRect(t.x,t.y,1,1),e.restore()},line({ctx:e,pos:t,pos2:n,color:a,color2:r,thickness:i,cap:s}){if(e.save(),e.beginPath(),a&&r){const o=e.createLinearGradient(t.x,t.y,n.x,n.y);o.addColorStop(0,a),o.addColorStop(1,r),e.strokeStyle=o}else a&&(e.strokeStyle=a);i&&(e.lineWidth=i),s&&(e.lineCap=s),e.moveTo(t.x,t.y),e.lineTo(n.x,n.y),e.stroke(),e.closePath(),e.restore()},arrow({ctx:e,pos:t,pos2:n,color:a,thickness:r,cap:i,join:s,label:o,headSize:c=6,headAngle:l=Math.PI/6,headLeft:f=!0,headRight:h=!0,headClose:d=!1,headFill:u=!1}){e.save();const w=Math.atan2(n.y-t.y,n.x-t.x),k=Math.sqrt((n.x-t.x)**2+(n.y-t.y)**2),x=c*Math.sign(k),M={x:n.x-x*Math.cos(w-l),y:n.y-x*Math.sin(w-l)},v={x:n.x-x*Math.cos(w+l),y:n.y-x*Math.sin(w+l)},y={x:M.x+(v.x-M.x)/2,y:M.y+(v.y-M.y)/2};a&&(e.strokeStyle=a),a&&u&&(e.fillStyle=a),r&&(e.lineWidth=r),i&&(e.lineCap=i),s&&(e.lineJoin=s),e.beginPath(),e.moveTo(t.x,t.y),f&&h?(d?e.lineTo(y.x,y.y):e.lineTo(n.x,n.y),e.moveTo(M.x,M.y),e.lineTo(n.x,n.y),e.lineTo(v.x,v.y),(d||u)&&e.closePath(),u&&e.fill()):(e.lineTo(n.x,n.y),f&&e.lineTo(M.x,M.y),h&&e.lineTo(v.x,v.y),(d||u)&&e.lineTo(y.x,y.y),u&&e.fill()),e.stroke(),o&&this.text({ctx:e,pos:{x:n.x,y:n.y+5},msg:o,size:12,color:a}),e.restore()},circle({ctx:e,pos:t,r:n,color:a,thickness:r,fill:i=!0}){e.save(),e.beginPath(),e.arc(t.x,t.y,n,0,Math.PI*2),i?(a&&(e.fillStyle=a),e.fill()):(a&&(e.strokeStyle=a),r&&(e.lineWidth=r),e.stroke()),e.closePath(),e.restore()},rectangle({ctx:e,pos:t,pos2:n,color:a,thickness:r,join:i,fill:s=!0}){e.save(),e.beginPath(),e.rect(t.x,t.y,n.x-t.x,n.y-t.y),s?(a&&(e.fillStyle=a),e.fill()):(a&&(e.strokeStyle=a),r&&(e.lineWidth=r),i&&(e.lineJoin=i),e.stroke()),e.closePath(),e.restore()},rectangleCentered({ctx:e,pos:t,w:n,h:a,color:r,thickness:i,join:s,fill:o=!0}){e.save();let c={x:t.x-n/2,y:t.y-a/2},l={x:t.x+n/2,y:t.y+a/2};this.rectangle({ctx:e,pos:c,pos2:l,color:r,thickness:i,join:s,fill:o}),e.restore()},rectangleDebug({ctx:e,pos:t,pos2:n,r:a=10,color:r="#3C3",colorBack:i="#8881"}){e.save(),this.rectangle({ctx:e,pos:t,pos2:n,color:i}),this.rectangle({ctx:e,pos:t,pos2:n,color:r,fill:!1});const s={x:t.x+(n.x-t.x)/2,y:t.y+(n.y-t.y)/2};this.circle({ctx:e,pos:s,r:a,color:r,fill:!1}),this.circle({ctx:e,pos:s,r:Math.min(Math.abs(t.x-n.x),Math.abs(t.y-n.y))/2,color:r,fill:!1});for(const o of[t,s,n])for(const c of[t,s,n]){let l={x:o.x,y:c.y};this.circle({ctx:e,pos:l,r:a,color:r,fill:!1}),this.line({ctx:e,pos:l,pos2:s,color:r,thickness:1})}e.restore()}};function z(e){const t=[];let n=2;for(;e>=2;)e%n===0?(t.push(n),e=e/n):n++;return t}function S(e){const t=e.length;if(!t)return{count:0,min:0,max:0,mean:0,median:0,stdev:0,sum:0};const n=[...e].sort((f,h)=>f-h),a=n.at(0)||0,r=n.at(-1)||0,i=n.reduce((f,h)=>h+f,0),s=i/t,o=((n.at(Math.floor(t/2))||0)+(n.at(Math.ceil(t/2))||0))/2,c=n.reduce((f,h)=>(s-h)**2+f)/t,l=Math.sqrt(c);return{count:t,min:a,max:r,mean:s,median:o,stdev:l,sum:i}}function R(e,t){const n=new Map;return e.forEach(a=>{const r=t(a);n.has(r)?n.get(r).push(a):n.set(r,[a])}),n}function q({modulo:e,multiple:t,radius:n,origin:a={x:0,y:0}}){const r=[];for(let i=0;i<e;i++){const s=i*t%e;r.push({start:i,end:s,...I({connection:{start:i,end:s},modulo:e,radius:n,origin:a})})}return r}function B({modulo:e,multiple:t,radius:n,origin:a={x:0,y:0}}){var o;const r=[];for(let c=0;c<e;c++)r.push(new Map);const i=[];for(let c=0;c<e;c++){const l=c*t%e;i[c]=l}for(let c=0;c<e;c++)for(let l=0;l<e;l++){const f=l*c%e,h=i[l];if(f!==h)continue;const d=r[l];d.has(f)||d.set(f,new Set),(o=d.get(f))==null||o.add(c)}const s=[];for(let c=0;c<e;c++){const l=r[c];for(const[f,h]of l)c!==f&&s.push({start:c,end:f,multiples:Array.from(h),...I({connection:{start:c,end:f},modulo:e,radius:n,origin:a})})}return s.sort((c,l)=>c.multiples.length-l.multiples.length)}function W({modulo:e,radius:t,origin:n={x:0,y:0}}){var i;const a=[];for(let s=0;s<e;s++)a.push(new Map);for(let s=0;s<e;s++)for(let o=0;o<e;o++){const c=o*s%e,l=a[o];l.has(c)||l.set(c,new Set),(i=l.get(c))==null||i.add(s)}const r=[];for(let s=0;s<e;s++){const o=a[s];for(const[c,l]of o)s!==c&&r.push({start:s,end:c,multiples:Array.from(l),...I({connection:{start:s,end:c},modulo:e,radius:t,origin:n})})}return r.sort((s,o)=>s.multiples.length-o.multiples.length)}function I({connection:e,modulo:t,radius:n,origin:a={x:0,y:0},rotation:r=-Math.PI/2}){const i=e.start/t*Math.PI*2+r,s=e.end/t*Math.PI*2+r;return{pos:g.cartesian({ang:i,mag:n},a),pos2:g.cartesian({ang:s,mag:n},a)}}function A({canvas:e,size:t,alpha:n=!1}){e.width=t,e.height=t;const a=e.getContext("2d",{alpha:n});if(!a)throw new Error("Failed to initialize canvas");return a.translate(t/2,t/2),a}function J({ctx:e,color:t="#000"}){e.save(),e.resetTransform(),b.rectangle({ctx:e,pos:{x:0,y:0},pos2:{x:e.canvas.width,y:e.canvas.height},color:t}),e.restore()}function C({ctx:e,pos:t={x:0,y:0},radius:n,gradient:a}){const r=e.createRadialGradient(t.x,t.y,0,t.x,t.y,n);Object.entries(a).forEach(([i,s])=>{r.addColorStop(parseFloat(i),s)}),e.fillStyle=r,b.circle({ctx:e,pos:t,r:n})}function $({ctx:e,lines:t,onProgress:n}){for(const[a,r]of t.entries())b.line({ctx:e,...r}),n&&a%100===0&&n({current:a,total:t.length});n&&n({current:t.length,total:t.length})}function V({canvas:e,specification:{size:t,modulo:n,multiple:a,padding:r=0,style:i,crop:s,labels:o=!0},onProgress:c}){console.debug("Preparing canvas...");const l=A({canvas:e,size:t,alpha:!0});console.debug("Computing lines...");const f=o?`${n}`.length:0,h=24,d=Math.max(f,2)*h*.6,u=t/2-r-d,w=a===void 0?W({modulo:n,radius:u}):B({modulo:n,multiple:a,radius:u}),k=j(w,u,10);console.debug(`lines: ${w.length}, density: ${k}`);let x=H(w,k),M=K(w,k);const v=Array(n).fill(0);if(w.forEach(({start:y,end:P,multiples:m})=>{v[y]+=m.length**3,v[P]+=m.length**3}),i==="plain"&&(x=x.map(y=>{var m;const P=a===void 0?((m=y.color)==null?void 0:m.split("/").at(-1))||" 1)":Math.min(1e3/n,.7)+.00392156862745098;return{...y,color:`rgb(255 255 255 /${P}`,thickness:1}}),M=[]),i==="fancy"&&(console.debug("Drawing background..."),l.globalCompositeOperation="source-over",C({ctx:l,radius:u,gradient:{0:"#11F8",1:"#F001"}}),C({ctx:l,radius:u,gradient:{.5:"#0000",1:"#F0F4"}}),C({ctx:l,radius:u,gradient:{0:"#FA1",.5:"#1850"}})),console.debug("Drawing lines..."),l.globalCompositeOperation="lighter",$({ctx:l,lines:x,onProgress:y=>c&&c(y.current/(x.length+M.length))}),i==="fancy"&&(console.debug("Shading..."),l.globalCompositeOperation="source-atop",C({ctx:l,radius:u,gradient:{.6:"#0000",1:"#000"}})),i==="fancy"&&(console.debug("Drawing accents..."),l.globalCompositeOperation="lighter",$({ctx:l,lines:M,onProgress:y=>c&&c((y.current+x.length)/(x.length+M.length))})),console.debug("Cropping..."),l.globalCompositeOperation="destination-in",b.circle({ctx:l,pos:{x:0,y:0},r:u-1,color:"#000"}),l.globalCompositeOperation="destination-over",s?b.circle({ctx:l,pos:{x:0,y:0},r:t/2,color:"#000"}):J({ctx:l,color:"#000"}),o===!0){console.debug("Drawing labels..."),l.globalCompositeOperation="source-over";const y=q({modulo:n,multiple:1,radius:u+d*.75}),P=y.length>1?g.distance(y[0].pos,y[1].pos):u,m=S(v),O=z(n).length===1,G=i==="plain"&&a!==void 0;y.forEach(({start:p,pos:E})=>{if(p!==0&&(O||G)&&P<d)return;const T=p===0?1:O||G?.3:g.clamp(v[p]**1.3/m.max,0,1);if(!T||T<.1)return;const F=`${p}`,N=E.x-h*.3*F.length,Q=E.y-h*.6,U=`rgb(255 255 255 / ${T})`;b.text({ctx:l,pos:{x:N,y:Q},msg:F,size:h,font:'"Fira Code", monospace',color:U})})}}function j(e,t,n){const r=S(e.map(i=>g.distance(i.pos,i.pos2))).sum/(Math.PI*t**2);return g.clamp(n/(r+1),.01,10)}function D(e){const t=S(e.map(a=>g.distance({x:0,y:0},g.midpoint(a.pos,a.pos2)))),n=S(e.map(a=>g.distance(a.pos,a.pos2)));return e.map(a=>{const r=g.distance({x:0,y:0},g.midpoint(a.pos,a.pos2)),i=r/t.max,s=g.distance(a.pos,a.pos2),o=s/n.max;return{...a,radius:r,radiusPercent:i,distance:s,distancePercent:o}})}function L(e){const t=R(e,r=>r.multiples.length),n=[...t.keys()].sort((r,i)=>r-i),a=S(n);return e.map(r=>{const i=r.multiples.length,s=i/a.max,o=n.length>1?n.indexOf(i)/(n.length-1):0,c=(t.get(i)||[]).length,l=c/e.length;return{...r,stack:i,stackMaxPercent:s,stackIndexPercent:o,stackSize:c,stackSizePercent:l}})}function H(e,t){const n=[];return D(L(e)).forEach(a=>{const{radiusPercent:r,distancePercent:i,stackMaxPercent:s,stackIndexPercent:o,stackSizePercent:c}=a,l=(1-r)*.7+.3,f=(1-i**9)*100+170,h=g.clamp(s*(1-c)*.9+.02*t,0,1),d=1+(s*.5+o*.5)*t;n.push({pos:a.pos,pos2:a.pos2,color:`oklch(${l} 0.5 ${f} / ${h})`,thickness:d})}),n}function K(e,t){const n=[];return D(L(e)).forEach(a=>{const{stackMaxPercent:r,stackIndexPercent:i,stackSizePercent:s}=a,o=(253/255-s*g.clamp(e.length/1500,0,1))**4+2/255,c=g.clamp(r**1.6,0,1)*o,l=1+(r*.5+i*.5)*t;c>=1/255&&n.push({pos:a.pos,pos2:a.pos2,color:`rgb(255 25 25 / ${c})`,thickness:l})}),n}self.onmessage=e=>{const t=e.data;if(t.action==="render"){const n=new OffscreenCanvas(t.specification.size,t.specification.size);V({canvas:n,specification:t.specification,onProgress:r=>self.postMessage({progressPercent:r})}),console.debug("Generating bitmap...");const a=n.transferToImageBitmap();self.postMessage({result:a},[a]),a==null||a.close()}}})();
